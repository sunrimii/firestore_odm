name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  # Job 1: Code Quality & Testing
  quality-check:
    name: Code Quality & Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“š Git Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŽ¯ Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: stable
          channel: stable
          cache: true

      - name: ðŸ“¦ Install Melos
        run: dart pub global activate melos

      - name: ðŸ”§ Bootstrap Workspace
        run: melos bootstrap

      - name: ðŸ” Verify Using Melos
        run: melos --version

      - name: ðŸ“Š Dependency Overview
        run: melos list --long

      - name: âœ¨ Check Code Formatting
        run: melos run format:check

      - name: ðŸ•µï¸ Analyze Code
        run: melos run analyze

      - name: ðŸ§ª Run Unit Tests
        run: melos run test:unit

      - name: ðŸ§ª Run Integration Tests
        run: melos run test:integration

      - name: ðŸ“‹ Validate Publish
        run: melos run publish:dry-run

  # Job 2: Version Check (only on main branch)
  version-check:
    name: Version Check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: quality-check
    
    steps:
      - name: ðŸ“š Git Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŽ¯ Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: ðŸ“¦ Install Melos
        run: dart pub global activate melos

      - name: ðŸ”§ Bootstrap Workspace
        run: melos bootstrap

      - name: ðŸ” Check Version Status
        run: melos run version:check

  # Job 3: Auto Publish (only on release)
  publish:
    name: Publish to pub.dev
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    needs: quality-check
    
    steps:
      - name: ðŸ“š Git Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸŽ¯ Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: stable
          channel: stable
          cache: true

      - name: ðŸ“¦ Install Melos
        run: dart pub global activate melos

      - name: ðŸ”§ Bootstrap Workspace
        run: melos bootstrap

      - name: ðŸ” Final Quality Check
        run: melos run check

      - name: ðŸš€ Publish to pub.dev
        env:
          PUB_TOKEN: ${{ secrets.PUB_TOKEN }}
        run: |
          echo "Setting up pub credentials..."
          mkdir -p ~/.pub-cache
          echo "$PUB_TOKEN" > ~/.pub-cache/credentials.json
          
          echo "Publishing packages..."
          melos run publish

      - name: ðŸ“ Create Release Notes
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            
            // Get package versions
            const packages = JSON.parse(execSync('melos list --json').toString());
            const publishedPackages = packages.filter(pkg => !pkg.private);
            
            let releaseNotes = '## ðŸ“¦ Published Packages\n\n';
            for (const pkg of publishedPackages) {
              releaseNotes += `- **${pkg.name}** v${pkg.version}\n`;
            }
            
            releaseNotes += '\n## ðŸ”— Links\n\n';
            for (const pkg of publishedPackages) {
              releaseNotes += `- [${pkg.name} on pub.dev](https://pub.dev/packages/${pkg.name})\n`;
            }
            
            // Update release description
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: context.payload.release.body + '\n\n' + releaseNotes
            });

  # Job 4: Security Audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“š Git Checkout
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: ðŸ“¦ Install Melos
        run: dart pub global activate melos

      - name: ðŸ”§ Bootstrap Workspace
        run: melos bootstrap

      - name: ðŸ”’ Run Security Audit
        run: |
          echo "Checking for outdated dependencies..."
          melos run deps:outdated || true
          
          echo "Running security audit..."
          # Add any security scanning tools here
          echo "Security audit completed"

  # Job 5: Documentation Check
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ðŸ“š Git Checkout
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: ðŸ“¦ Install Melos
        run: dart pub global activate melos

      - name: ðŸ”§ Bootstrap Workspace
        run: melos bootstrap

      - name: ðŸ“– Generate Documentation
        run: |
          echo "Generating documentation..."
          dart doc --output docs/ packages/firestore_odm/
          dart doc --output docs/ packages/firestore_odm_annotation/
          dart doc --output docs/ packages/firestore_odm_builder/
          
      - name: ðŸ“‹ Check Documentation Coverage
        run: |
          echo "Checking documentation coverage..."
          # Add documentation coverage checks here
          echo "Documentation check completed"